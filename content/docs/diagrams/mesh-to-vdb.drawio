<mxfile host="app.diagrams.net" modified="2026-01-23T00:00:00.000Z" agent="Cunning3D" version="1.0">
  <diagram name="Mesh to VDB Pipeline" id="mesh-to-vdb">
    <mxGraphModel dx="1200" dy="800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="700" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        
        <!-- Title -->
        <mxCell id="title" value="Pipeline: Mesh to VDB" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=24;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="400" height="40" as="geometry"/>
        </mxCell>
        
        <!-- Step 1: Input Analysis -->
        <mxCell id="s1-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;strokeWidth=2" vertex="1" parent="1">
          <mxGeometry x="60" y="100" width="200" height="120" as="geometry"/>
        </mxCell>
        <mxCell id="s1-num" value="1" style="ellipse;whiteSpace=wrap;html=1;fillColor=#666666;strokeColor=#666666;fontColor=#ffffff;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="70" y="110" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="s1-title" value="Mesh Analysis" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="115" width="150" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="s1-desc" value="• Extract Vertices&#xa;• Extract Indices&#xa;• Build Parry3d TriMesh&#xa;(Accelerated BVH)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;spacing=5" vertex="1" parent="1">
          <mxGeometry x="70" y="150" width="180" height="60" as="geometry"/>
        </mxCell>
        
        <mxCell id="arr1" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="260" y="160" as="sourcePoint"/>
            <mxPoint x="300" y="160" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- Step 2: Sparse Chunking -->
        <mxCell id="s2-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=2" vertex="1" parent="1">
          <mxGeometry x="300" y="100" width="240" height="120" as="geometry"/>
        </mxCell>
        <mxCell id="s2-num" value="2" style="ellipse;whiteSpace=wrap;html=1;fillColor=#6c8ebf;strokeColor=#6c8ebf;fontColor=#ffffff;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="310" y="110" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="s2-title" value="Sparse Chunking" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="340" y="115" width="180" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="s2-desc" value="• Iterate Triangles&#xa;• Calculate AABB + Bandwidth&#xa;• Identify touched CHUNKS&#xa;• Insert into DashSet (Parallel)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;spacing=5" vertex="1" parent="1">
          <mxGeometry x="310" y="150" width="220" height="60" as="geometry"/>
        </mxCell>
        
        <mxCell id="arr2" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="540" y="160" as="sourcePoint"/>
            <mxPoint x="580" y="160" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- Step 3: Parallel Filling -->
        <mxCell id="s3-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2" vertex="1" parent="1">
          <mxGeometry x="580" y="100" width="260" height="120" as="geometry"/>
        </mxCell>
        <mxCell id="s3-num" value="3" style="ellipse;whiteSpace=wrap;html=1;fillColor=#82b366;strokeColor=#82b366;fontColor=#ffffff;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="590" y="110" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="s3-title" value="Parallel Chunk Filling" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="620" y="115" width="200" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="s3-desc" value="• For active chunks (Rayon)&#xa;• For each voxel in chunk&#xa;• Parry: project_point()&#xa;• Calculate Signed Distance" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;spacing=5" vertex="1" parent="1">
          <mxGeometry x="590" y="150" width="240" height="60" as="geometry"/>
        </mxCell>
        
        <mxCell id="arr3" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#666666" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="840" y="160" as="sourcePoint"/>
            <mxPoint x="880" y="160" as="targetPoint"/>
          </mxGeometry>
        </mxCell>
        
        <!-- Step 4: Output -->
        <mxCell id="s4-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;strokeWidth=2" vertex="1" parent="1">
          <mxGeometry x="880" y="100" width="200" height="120" as="geometry"/>
        </mxCell>
        <mxCell id="s4-num" value="4" style="ellipse;whiteSpace=wrap;html=1;fillColor=#d6b656;strokeColor=#d6b656;fontColor=#ffffff;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="890" y="110" width="30" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="s4-title" value="Grid Construction" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="920" y="115" width="150" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="s4-desc" value="• Assemble VoxelGrid&#xa;• Store in VolumeHandle&#xa;• Add to Geometry output" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;fontSize=11;spacing=5" vertex="1" parent="1">
          <mxGeometry x="890" y="150" width="180" height="60" as="geometry"/>
        </mxCell>
        
        <!-- Code Details -->
        <mxCell id="code-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;arcSize=5" vertex="1" parent="1">
          <mxGeometry x="60" y="260" width="1020" height="200" as="geometry"/>
        </mxCell>
        <mxCell id="code-title" value="Core Logic: Chunk Processing" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="80" y="270" width="300" height="25" as="geometry"/>
        </mxCell>
        
        <mxCell id="code-block" value="fn process_active_chunk(chunk_idx, limit, voxel_size, trimesh) {&#xa;    let chunk_origin = chunk_idx * CHUNK_SIZE;&#xa;    for voxel in CHUNK {&#xa;        let center = (chunk_origin + voxel).as_vec3() * voxel_size;&#xa;        &#xa;        // Robust Global Query via Parry&#xa;        let proj = trimesh.project_point(&center);&#xa;        let dist = distance(&center, &proj.point);&#xa;        let inside = trimesh.contains_point(&center);&#xa;        &#xa;        // Shell Dilate&#xa;        let thickness = voxel_size * 1.0;&#xa;        let val = if inside { -dist - thickness } else { dist - thickness };&#xa;        &#xa;        chunk.set(voxel, val.clamp(-limit, limit));&#xa;    }&#xa;}" style="text;html=1;strokeColor=#9673a6;fillColor=#f5f5f5;align=left;verticalAlign=top;fontSize=11;rounded=1;fontFamily=Courier New;spacing=10" vertex="1" parent="1">
          <mxGeometry x="80" y="300" width="550" height="140" as="geometry"/>
        </mxCell>
        
        <!-- Optimization Note -->
        <mxCell id="opt-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf" vertex="1" parent="1">
          <mxGeometry x="660" y="300" width="380" height="140" as="geometry"/>
        </mxCell>
        <mxCell id="opt-title" value="Optimization: Level 4 Sparse Collection" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="660" y="310" width="380" height="20" as="geometry"/>
        </mxCell>
        <mxCell id="opt-text" value="We don't collect individual voxels. We collect 16x16x16 CHUNKS.&#xa;&#xa;1. Triangle AABB expanded by Bandwidth&#xa;2. Map AABB to Chunk Coordinates&#xa;3. DashSet&lt;IVec3&gt; stores unique Chunk IDs&#xa;&#xa;Reduces contention by 4096x compared to voxel-wise collection." style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;spacing=5" vertex="1" parent="1">
          <mxGeometry x="670" y="340" width="360" height="90" as="geometry"/>
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
